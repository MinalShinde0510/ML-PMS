@model CloudTrixApp.Models.Invoice

@{
    ViewBag.Title = "Edit";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="content-wrapper">
    <section class="content-header">
        <h1>

            <small></small>
        </h1>
        <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
            <li><a href="#">Invoice</a></li>
            <li class="active">Edit Invoice</li>
        </ol>
    </section>
    <div class="wraper container-fluid ">
        <div class="row">
            <div class="col col-md-11">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <h3 class="panel-title">Edit Invoice </h3>
                    </div>
                    <div class="panel-body">

                        @using (Html.BeginForm())
                        {
                            @Html.AntiForgeryToken()

                            <div class="form-horizontal">
                                <h4>Invoice</h4>
                                <hr />
                                @Html.ValidationSummary(true)
                                @Html.HiddenFor(model => model.InvoiceID)

                                <div class="container-fluid">
                                    <div class="col-sm-4">
                                        <div class="form-group">
                                            <label for="CompanyName"> Company Name :</label>
                                            @Html.DropDownList("CompanyID", null, "Select Company Name", new { @class = "form-control clsCustomer", @id = "CompanyID", @autocomplete = "off" })
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="Invoice_Type"> Invoice Type : </label>
                                            @Html.DropDownList("Invoice_Type", new List<SelectListItem>
                                        {
                                            new SelectListItem() {Text = "Tax Invoice", Value="Tax Invoice"},
                                            new SelectListItem() {Text = "Proforma Invoice", Value="Proforma Invoice"},
                                        }, "Select Invoice Type", new { @class = "form-control", onchange = "blankme(this.id)" })
                                        </div>
                                    </div>

                                    <div class="col-sm-4">
                                        <div class="form-group">
                                            <label for="AddUserID"> Created By :</label>
                                            @*@Html.TextBox("AddUserID", User.Identity.Name.Split('|')[0], new { @class = "form-control", @placeholder = "", @id = "AddUserID", @style = "width : 100%", autocomplete = "off", @readonly = "readonly" })*@
                                            @Html.TextBox("AddUserID", User.Identity.Name.Split('|')[0], new { @class = "form-control  ", @placeholder = "Created by ", autocomplete = "off", @readonly = "readonly" })
                                        </div>
                                    </div>
                                </div>
                                <div class="container-fluid">

                                    <div class="col-sm-4">
                                        <div class="form-group">
                                            <label for="InvoiceNo"> Invoice No : </label>
                                            @Html.TextBox("InvoiceNo", null, new { @class = "form-control", @placeholder = "Invoice No", autocomplete = "off" })
                                        </div>
                                    </div>
                                    <div class="col-sm-4">
                                        <div class="form-group">
                                            <label for="InvoiceDate"> InvoiceDate :</label>
                                            @Html.TextBox("InvoiceDate", DateTime.Now.Date.ToShortDateString(), new { @class = "form-control datepicker", @placeholder = "Enter Invoice Date", autocomplete = "off" })
                                        </div>
                                    </div>
                                    <div class="col-sm-4">
                                        <div class="form-group">
                                            <label for="AddDate"> AddDate :</label>
                                            @Html.TextBox("AddDate", DateTime.Now, new { @class = "form-control datepicker ", autocomplete = "off", @readonly = "readonly" })
                                        </div>
                                    </div>
                                </div>
                                <div class="container-fluid">
                                    <div class="col-sm-4">
                                        <div class="form-group">
                                            <label for="ClientID"> Client Name : </label>
                                            @Html.DropDownList("ClientID", null, "Select Client Name", new { @class = "form-control clsCustomer", @id = "ClientID", @autocomplete = "off" })
                                        </div>
                                    </div>
                                    <div class="col-sm-4">
                                        <div class="form-group">
                                            <label for="ClientAddress"> Client Address : </label>
                                            @Html.TextBox("ClientAddress", null, new { @class = "form-control", @placeholder = "", @id = "ClientAddress", @style = "width : 100%", autocomplete = "off", @readonly = "readonly" })
                                        </div>
                                    </div>
                                    <div class="col-sm-4">
                                        <div class="form-group">
                                            <label for="ClientContactNo"> Client Contact No :</label>
                                            @Html.TextBox("ClientContactNo", null, new { @class = "form-control", @placeholder = "", @id = "ClientContactNo", @style = "width : 100%", autocomplete = "off", @readonly = "readonly" })

                                        </div>
                                    </div>
                                </div>
                                <div class="container-fluid">
                                    <div class="col-sm-4">
                                        <div class="form-group">
                                            <label for="ProjectID"> Project Name :</label>
                                            @Html.DropDownList("ProjectID", null, "Select Project Name", new { @class = "form-control  ", @id = "ProjectID", @placeholder = "Project Name ", autocomplete = "off" })
                                            @*<select id="ProjectID" class="form-control">
                                                    <option value="">Select Project</option>
                                                </select>*@
                                        </div>
                                    </div>
                                    <div class="col-sm-4">
                                        <div class="form-group">
                                            <label for="ClientGSTIN"> Client GSTIN  :</label>
                                            @Html.TextBox("ClientGSTIN", null, new { @class = "form-control", @placeholder = "", @id = "ClientGSTIN", @style = "width : 100%", autocomplete = "off", @readonly = "readonly" })
                                        </div>
                                    </div>
                                    <div class="col-sm-4">
                                        <div class="form-group">
                                            <label for="ClientEMail"> Client EMail :</label>
                                            @Html.TextBox("ClientEMail", null, new { @class = "form-control", @placeholder = "", @id = "ClientEMail", @style = "width : 100%", autocomplete = "off", @readonly = "readonly" })
                                        </div>
                                    </div>
                                </div>

                                @* Modal PopUp for adding New Item Details*@
                                @*<div class="container-fluid">
                                        <button type="button" id="btnShowModal" class="btn btn-success">Add New Item To List</button>
                                        &nbsp;&nbsp;&nbsp;
                                        <small id="error_SubTotal" class="form-text error_msg">Atleast add one item</small>

                                    </div>*@
                                <div class="modal fade" tabindex="-1" id="loginModal" data-keyboard="false" data-backdrop="static">
                                    @*<div class="modal-dialog modal-lg">*@
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal">
                                                ×
                                            </button>
                                            <h4 class="modal-title">Add Invoice Items</h4>
                                        </div>
                                        <div class="modal-body">
                                            <input type="text" id="CompanyID_GST" hidden />
                                            <input type="text" id="ClientID_GST" hidden />
                                            <form class="row" role="form">
                                                <table class="table table-hover table-responsive ">
                                                    <thead class="bg-light-blue">
                                                        <tr>
                                                            <td style="width:60%"><b>Description</b></td>
                                                            <td style="width:5%"><b>Quantity</b></td>
                                                            <td style="width:10%"><b>Rate</b></td>
                                                            <td style="width:10%"><b>Tax(%)</b></td>
                                                            <td style="width:15%"><b>Amount</b></td>
                                                        </tr>
                                                    </thead>
                                                    <tbody class="bg-gray">
                                                        <tr>
                                                            <td style="width:60%">
                                                                @Html.TextBox("Description", null, new { @class = "form-control", @id = "txtDescription", @type = "text", @placeholder = "Enter Description ", autocomplete = "off" })
                                                            </td>
                                                            <td style="width:5%">
                                                                @Html.TextBox("Quantity", null, new { @class = "form-control", @id = "txtQuantity", @type = "text", @placeholder = "Enter Quantity ", autocomplete = "off" })
                                                            </td>
                                                            <td style="width:10%">
                                                                @Html.TextBox("Price", null, new { @class = "form-control", @type = "text", @id = "txtPrice", @placeholder = "Enter Rate ", autocomplete = "off" })
                                                            </td>
                                                            <td style="width:10%">
                                                                <select id="txtTAX" class="form-control">
                                                                    <option>0 %</option>
                                                                    <option>5 %</option>
                                                                    <option>8 %</option>
                                                                    <option>12 %</option>
                                                                    <option>18 %</option>
                                                                </select>
                                                            </td>
                                                            <td style="width:15%">
                                                                @Html.TextBox("Amount", null, new { @class = "form-control", @type = "text", @tabIndex = "-1", @id = "txtAmount", @placeholder = "0", autocomplete = "off", @readonly = "readonly" })
                                                                <small id="error_price" class="form-text error_msg">Rate is required</small><br />
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td></td>
                                                            <td></td>
                                                            <td><label>IGST</label></td>
                                                            <td>
                                                                @Html.TextBox("IGST_Per", null, new { @class = "form-control", @type = "text", @id = "IGST_Per", @placeholder = "0", autocomplete = "off", @readonly = "readonly" })
                                                            </td>
                                                            <td style="width:10%">@Html.TextBox("IGST", null, new { @class = "form-control", @tabIndex = "-1", @type = "number", @id = "IGST", @placeholder = "0", autocomplete = "off", @readonly = "readonly" })</td>
                                                        </tr>
                                                        <tr>
                                                            <td></td>
                                                            <td></td>
                                                            <td><label>CGST</label></td>
                                                            <td>
                                                                @Html.TextBox("CGST_Per", null, new { @class = "form-control", @type = "text", @id = "CGST_Per", @placeholder = "0", autocomplete = "off", @readonly = "readonly" })
                                                            </td>
                                                            <td style="width:10%">@Html.TextBox("CGST", null, new { @class = "form-control", @tabIndex = "-1", @type = "number", @id = "CGST", @placeholder = "0", autocomplete = "off", @readonly = "readonly" })</td>
                                                        </tr>
                                                        <tr>
                                                            <td></td>
                                                            <td></td>
                                                            <td><label>SGST</label></td>
                                                            <td>
                                                                @Html.TextBox("SGST_Per", null, new { @class = "form-control", @type = "text", @id = "SGST_Per", @placeholder = "0", autocomplete = "off", @readonly = "readonly" })
                                                            </td>
                                                            <td style="width:10%">@Html.TextBox("SGST", null, new { @class = "form-control", @tabIndex = "-1", @type = "number", @id = "SGST", @placeholder = "0", autocomplete = "off", @readonly = "readonly" })</td>
                                                        </tr>
                                                        <tr>
                                                            <td></td>
                                                            <td></td>
                                                            <td></td>
                                                            <td><label>Amount</label> </td>
                                                            <td style="width:10%">@Html.TextBox("txtTotAmt", null, new { @class = "form-control", @type = "text", @id = "txtTotAmt", @style = "width : 150px", @placeholder = "0", autocomplete = "off", @readonly = "readonly" })</td>
                                                        </tr>
                                                    </tbody>
                                                </table>

                                                @*   Total Amount and Add to List Table*@
                                                <table class="table table-hover table-responsive">
                                                    <thead>
                                                        <tr>
                                                            <td style="width:80%"></td>
                                                            <td style="width:10%">
                                                                <button type="submit" id="addToList" class="btn btn-success">Add To List</button>
                                                            </td>
                                                            <td style="width:10%">
                                                                <button type="button" id="btnHideModal" class="btn btn-primary ">Close</button>
                                                            </td>
                                                        </tr>
                                                    </thead>
                                                </table>
                                            </form>
                                        </div>
                                    </div>
                                    @*</div>*@
                                </div>
                                @* END Modal PopUp for adding New Item Details*@

                                <div class="col-sm-12">
                                    <div class="form-group">
                                        <br />
                                        <div class="panel panel-color panel-primary">
                                            <div class="panel-heading">
                                                <h3 class="panel-title">Item List</h3>
                                            </div>
                                            <div class="panel-body">

                                                <table class="table table-hover table-responsive" id="detailsTable">
                                                    <thead>
                                                        <tr>
                                                            <th>InvoiceItemID</th>
                                                            <th style="width:40px">Description</th>
                                                            <th>Qty</th>
                                                            <th>Rate</th>
                                                            <th>Tax(%)</th>
                                                            <th>Amount</th>
                                                            <th>IGST</th>
                                                            <th>IGST Amt</th>
                                                            <th>CGST</th>
                                                            <th>CGST Amt</th>
                                                            <th>SGST</th>
                                                            <th>SGST Amt</th>
                                                            <th>Total Amt</th>
                                                            <th style="width:20px"></th>
                                                        </tr>
                                                    </thead>
                                                    <tbody></tbody>
                                                    <tfoot>
                                                        @foreach (var Items in ViewBag.InvoiceItem)
                                                        {
                                                            <tr>
                                                                <td>@Items.InvoiceItemID</td>
                                                                <td style="word-break:break-all;">@Items.Description</td>
                                                                <td>@Items.Quantity</td>
                                                                <td>@Items.Rate</td>
                                                                <td>@Items.Tax</td>
                                                                <td>@Items.Amount</td>
                                                                <td>@Items.IGSTRate</td>
                                                                <td>@Items.IGST_Amt</td>
                                                                <td>@Items.CGSTRate</td>
                                                                <td>@Items.CGST_Amt</td>
                                                                <td>@Items.SGSTRate</td>
                                                                <td>@Items.SGST_Amt</td>
                                                                <td class="amount">@Items.Total_Amt </td>
                                                            </tr>

                                                        }
                                                        <tr>
                                                            <td></td>
                                                            <td></td>
                                                            <td></td>
                                                            <td></td>
                                                            <td></td>
                                                            <td></td>
                                                            <td></td>
                                                            <td></td>
                                                            <td></td>
                                                            <td></td>
                                                            <td></td>
                                                            <td><strong> Total:</strong> </td>
                                                            <td>
                                                                <strong id="SubTotal" class="amount"></strong>
                                                            </td>
                                                        </tr>
                                                    </tfoot>
                                                </table>
                                            </div>
                                        </div>
                                        <br />
                                    </div>
                                </div>
                                <div class="container-fluid">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="Payment"> Payment Method : </label>
                                            @Html.DropDownList("Payment_Method", new List<SelectListItem>
                                        {
                                            new SelectListItem() {Text = "Cash", Value="Cash"},
                                            new SelectListItem() {Text = "Check", Value="Check"},
                                        }, "Select Payment", new { @class = "form-control", onchange = "blankme(this.id)" })
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="Status"> Status : </label>
                                            @Html.DropDownList("InvoiceStatus", new List<SelectListItem>
                                        {
                                            new SelectListItem() {Text = "Due", Value="Due"},
                                            new SelectListItem() {Text = "Paid", Value="Paid"},
                                        }, "Select Status", new { @class = "form-control", onchange = "blankme(this.id)" })
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="AdditionalDiscount"> Discount : </label>
                                            @Html.TextBox("AdditionalDiscount", null, new { @class = "form-control", @id = "AdditionalDiscount", @type = "number", @placeholder = "Discount Amount ", onchange = "DiscountAmount()" })
                                        </div>
                                    </div>
                                </div>
                                <div class="container-fluid">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="Notes"> Notes: </label>
                                            @Html.TextArea("Notes", new { @class = "form-control ", @rows = "2", @placeholder = "Enter Notes" })
                                        </div>
                                    </div>
                                    <div class="col-md-4"></div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="GrandTotal"> Grand Total : </label>
                                            @Html.TextBox("GrandTotal", null, new { @class = "form-control", @placeholder = "", @id = "GrandTotal", autocomplete = "off", @readonly = "readonly" })
                                            @*<h5 id="GrandTotal" class="form-control"> </h5>*@
                                            <small id="error_GrandTotal" class="form-text error_msg">Total is empty</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="container-fluid">
                                    <div><hr size=2><br /></div>
                                    <div class="col-sm-12">
                                        <div class="form-group">
                                            <input id="BtnInvoiceEdit" class="btn btn-success col-md-3 pull-right" type="submit" value="Edit Invoice" />
                                            &nbsp;&nbsp;
                                            @Html.ActionLink("Back to List", "Index", null, null, new { @class = "btn btn-primary" })
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/bundles/ApplicationJquery")
    <script type="text/javascript">

        $(document).ready(function () {
            calculateSum();
            $("#InvoiceDate").datepicker({
                format: 'mm/dd/yyyy',
                startDate: new Date('2020-1-5'),
                endDate: new Date('2040-12-31')
            });
            $('#Discount').change(function () {
                calculateSum();
            });
            function calculateSum() {
                var sum = 0;
                $(".amount").each(function () {
                    var value = $(this).text();
                    if (!isNaN(value) && value.length !== 0) { sum += parseFloat(value) }
                });
                if (sum == 0.0) {
                    $('#Discount').text("0");
                    $('#GrandTotal').text("0")
                }
                $('#SubTotal').text(sum.toFixed(2));
                $('#GrandTotal').text(sum.toFixed(2));
                var b = parseFloat($('#Discount').val()).toFixed(2);
                if (isNaN(b)) return;
                var a = parseFloat($('#SubTotal').text()).toFixed(2); $('#GrandTotal').text(a - b)
            };


            $("#BtnInvoiceEdit").click(function (e) {
                e.preventDefault();
                //  if (submitValidation()) {
                var orderArr = [];
                orderArr.length = 0;
                $.each($("#detailsTable tbody tr"),
                    function () {
                        orderArr.push({
                            InvoiceItemID: $(this).find('td:eq(0)').html(),
                            Description: $(this).find('td:eq(1)').html(),
                            Quantity: ($(this).find('td:eq(2)')).html(),
                            Rate: ($(this).find('td:eq(3)')).html(),
                            Tax: $(this).find('td:eq(4)').html(),
                            Amount: $(this).find('td:eq(5)').html(),
                            IGSTRate: $(this).find('td:eq(6)').html().replace('%', ''),
                            IGST_Amt: $(this).find('td:eq(7)').html(),
                            CGSTRate: ($(this).find('td:eq(8)')).html().replace('%', ''),
                            CGST_Amt: $(this).find('td:eq(9)').html(),
                            SGSTRate: ($(this).find('td:eq(10)')).html().replace('%', ''),
                            SGST_Amt: $(this).find('td:eq(11)').html(),
                            Total_Amt: $(this).find('td:eq(12)').html()

                        })
                    });
                var data = JSON.stringify({
                    InvoiceID: $("#InvoiceID").val(),
                    CompanyID: $("#CompanyID").val(),
                    Invoice_Type: $("#Invoice_Type").val(),
                    AddUserID: $("#AddUserID").val(),
                    InvoiceNo: $("#InvoiceNo").val(),
                    InvoiceDate: $("#InvoiceDate").val(),
                    AddDate: $("#AddDate").val(),
                    ClientID: $("#ClientID").val(),
                    ClientName: $("#ClientID").find("option:selected").text(),
                    ClientAddress: $("#ClientAddress").val(),
                    ClientContactNo: $("#ClientContactNo").val(),
                    ProjectID: $("#ProjectID").val(),
                    ClientGSTIN: $("#ClientGSTIN").val(),
                    ClientEMail: $("#ClientEMail").val(),
                    Payment_Method: $("#Payment_Method").val(),
                    InvoiceStatus: $("#InvoiceStatus").val(),
                    AdditionalDiscount: parseFloat($('#Discount').val()).toFixed(2),
                    Notes: $("#Notes").val(),
                    GrandTotal: parseFloat($('#GrandTotal').text()).toFixed(2),
                    ArchiveUserID: $("#AddUserID").val(),
                    ArchiveDate: $("#AddDate").val(),
                    Items: orderArr

                });
                console.log(data);
                if (this.id == "BtnInvoiceEdit") {
                    UpdateOrder(data);
                }
                window.location.href = "/Invoice/Index";
                // }
            });
            function UpdateOrder(data) {
                return $.ajax({
                    type: 'POST',
                    url: '/Invoice/Edit',
                    data: data,
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                })
            }
        });
    </script>
}

